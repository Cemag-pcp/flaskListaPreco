{% extends "layout.html" %}
{% block body %}

{% with messages = get_flashed_messages()  %}
  {% if messages %}
  {% for message in messages %}
  <div class="alert alert-success alert-dismissible fade show" id="alerta_Os" role="alert">
    {{ message }}
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">×</span>
    </button>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}
<div class="container" id="titulo">
  <h2>Lista de preços</h2>
</div>
<div class="container filter-wrapper2">
  <div>
      <label for="filtro-nome">Nome:</label>
      <select id="filtro-nome" class="form-control" sdata-live-search="true" style="width: 90%;" onchange="atualizarCliente()">
          <option value="">Selecionar</option>
          {% for nome in nome_cliente %}
          <option value="{{nome[0]}}">{{nome[0]}}</option>
          {% endfor %}
      </select>
    </div>
  
    <div>
      <label for="filtro-contato">Contato:</label>
      <select id="filtro-contato" class="form-control" style="width: 90%;" onchange="atualizarCliente()">
          <option></option>
      </select>
    </div>

    <div>
      <label for="forma-pagamento">Pagamento:</label>
      <select id="forma-pagamento" class="form-control"  style="width: 90%;" onchange="atualizarCliente()" >
        <option></option>
      </select>
    </div>
    <div>
      <button id="filtrar" onclick="atualizar_regiao()">Filtrar Preço</button>
    </div>
</div>

<div class="container filter-wrapper" style="margin-top: 20px;">
  <div class="hidden">
    <label for="filtro-descricao">Categoria:</label>
    <select id="filtro-descricao" onchange="atualizarDados()">
        <option value="">Selecionar</option>
        {% for descricao in descricao_unique %}
        <option>{{descricao[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div class="hidden">
    <label for="filtro-modelo">Modelo:</label>
    <select id="filtro-modelo" onchange="atualizarDados()">
      <option value="">Selecionar</option>
      {% for modelo in modelo_unique %}
      <option>{{modelo[0]}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="hidden">
    <label for="filtro-eixo">Eixo:</label>
    <select id="filtro-eixo" onchange="atualizarDados()">
      <option value="">Selecionar</option>
      {% for eixo in eixo_unique %}  
      <option>{{eixo[0]}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="hidden">
    <label for="filtro-molaFreio">Mola/Freio:</label>
    <select id="filtro-molaFreio" onchange="atualizarDados()">
        <option value="">Selecionar</option>
        {% for mola in mola_freio_unique %}
        <option>{{mola[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div class="hidden">
    <label for="filtro-tamanho">Tamanho:</label>
    <select id="filtro-tamanho" onchange="atualizarDados()">
        <option value="">Selecionar</option>
        {% for tamanho in tamanho_unique %}
        <option>{{tamanho[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div class="hidden">
    <label for="filtro-rodado">Rodado:</label>
    <select id="filtro-rodado" onchange="atualizarDados()">
        <option value="">Selecionar</option>
        {% for rodado in rodado_unique %}
        <option>{{rodado[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div class="hidden">
    <label for="filtro-pneu">Pneu:</label>
    <select id="filtro-pneu" onchange="atualizarDados()">
        <option value="">Selecionar</option>
        {% for pneu in pneu_unique %}
        <option>{{pneu[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div class="hidden">
    <label for="filtro-descricao-generica">Opcionais:</label>
    <select id="filtro-descricao-generica" onchange="atualizarDados()">
        <option value="">Selecionar</option>
        {% for descricao_generica in descricao_generica_unique %}
        <option>{{descricao_generica[0]}}</option>
        {% endfor %}
    </select>
  </div>
   <!-- <button onclick="enviarDados()">Enviar Dados Selecionados</button>
     -->
  <!-- <button onclick="enviarDados()">Enviar Dados Selecionados</button> -->
  <!-- <button class="hidden" id="limpar" onclick="limparFiltros()">Limpar Filtros</button> -->
</div>

<div class="container pt-4 hidden" style="transition: 0.5s;">
    <div class="row">
        <div style="position: relative;">
            <a href="/export/pdf-all">
                <i class="fas fa-file-pdf" style="font-size:20px;color:red"></i>
            </a>
            <table id="table1" class="table table-striped responsive-table">
              <thead>
                  <tr>
                      <th>Família</th>
                      <th>Código</th>
                      <th>Descrição</th>
                      <th>Cor</th>
                      <th>Preço</th>
                      <th>Preço c/ desconto</th>
                      <th>Favorito</th>
                  </tr>
              </thead>
              <tbody>
                {% for row in data %}
                  <tr>
                    <td data-label="Modelo">{{row[11]}}</td>
                    <td data-label="Código" id ='codigo'>{{row[1]}}</td>
                    <td data-label="Descrição">{{row[2]}}</td>
                    <td data-label="Cor">
                      <select id="cor" class="cor-dropdown" style="width:160px;">
                        <option value="Laranja" selected>Laranja</option>
                        <option value="Verde">Verde</option>
                        <option value="Vermelha">Vermelha</option>
                        <option value="Azul">Azul</option>
                        <option value="Amarela">Amarela</option>
                      </select>
                    </td>
                    <td data-label="Preço" style="white-space: nowrap;">{{row[23]}}</td>
                    <td data-label="Preço Final">
                      <input class="row-data preco-input" name="preco" placeholder="Preço c/ desc." style="width: 115px;" oninput="formatPriceInput(event);">
                    </td>
                    
                    <td data-label="Favorito">
                      <div class="toggle" id="maquina-parada-toggle">
                        <label class="switch2">
                          {% if row[30] == 'on' %}:
                          <input class="btn btn-secondary btn-sm favorito-btn" type="checkbox" name="favorito" id="favorito" data-row-id="{{row[1]}}" checked> 
                          <span class="slider round"></span>
                          {% else %}
                          <input class="btn btn-secondary btn-sm favorito-btn" type="checkbox" name="favorito" id="favorito" data-row-id="{{row[1]}}" > 
                          <span class="slider round"></span>
                          {% endif %}
                        </label>
                      </div>
                    </td>

                    <td data-label="Selecionar">
                      <button class="btn btn-primary btn-sm" onclick="toggleRowColor(this); toggleCardItem(this);" id ='botão_enviar_carrinho'><i class="fa-sharp fa-solid fa-paper-plane"></i>   Enviar</button>
                    </td>                
                  </tr>
                  {% endfor %}
                </tbody>
            </table>  
        </div>
    </div>
</div>

<div id="loading-overlay" style="display: none;">
  <div id="loading-spinner"></div>
</div>

<div id="modalEnviar" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span> <!-- Botão de fechar -->
    
    <div>
      <label for="observacao">Observações:</label>
      <textarea id="observacao" rows="4" cols="45"></textarea>
    </div>

    <button class="enviarModal" id="enviar-button" onclick="enviarDados()">Enviar</button>
  </div>
</div>

<script>
  // Manipulador de evento de clique para botões favoritos
  $('#table1').on('click', '.favorito-btn', function(event) {
    // Obter o estado do favorito e o ID da linha
    var favoriteState = this.checked ? 'on' : 'off';
    var rowId = this.getAttribute('data-row-id');

    // Enviar a solicitação POST ao backend do Python
    fetch('/favoritos', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        favorite: favoriteState,
        rowId: rowId
      })
    })
    .then(function(response) {
      // Lidar com a resposta do servidor, se necessário
    })
    .catch(function(error) {
      // Lidar com erros de solicitação, se necessário
    });
  });
</script>

<script>
  // Inicialize o Select2 no elemento 'mySelect'
  $(document).ready(function() {
    $('#filtro-nome').select2();
  });
</script>

<script>
  // Selecionar o elemento do botão de fechar
  var closeButton = document.querySelector(".modal .close");

  // Selecionar o elemento do modal
  var modal = document.getElementById("modalEnviar");

  // Função para fechar o modal
  function fecharModal() {
    modal.style.display = "none";
  }

  // Configurar evento de clique para fechar o modal quando o botão de fechar for clicado
  closeButton.addEventListener("click", fecharModal);
  
</script>

<script>
  $(document).ready(function() {
    // Ao clicar no botão "Enviar"
    $('#btnEnviar').click(function() {
      // Exibir o modal
      $('#modalEnviar').show();
    });

    // Ao clicar no botão "Fechar" do modal
    $('#modalEnviar').on('click', '.fecharModal', function() {
      // Esconder o modal
      $('#modalEnviar').hide();
    });

      // Esconder o modal após o envio
      $('#modalEnviar').hide();
    });

</script>

<script>// Atualizar dados de dropdown e tabela
  function atualizarDados() {
    $("#loading-overlay").show();
    var descricao = $('#filtro-descricao').val();
    var modelo = $('#filtro-modelo').val();
    var eixo = $('#filtro-eixo').val();
    var mola_freio = $('#filtro-molaFreio').val();
    var tamanho = $('#filtro-tamanho').val();
    var rodado = $('#filtro-rodado').val();
    var pneu = $('#filtro-pneu').val();
    var descricao_generica = $('#filtro-descricao-generica').val();
    var filtro_nome = $('#filtro-nome').val();

    // obter os valores selecionados em cada dropdown

    // enviar a solicitação AJAX para o servidor
    $.ajax({
      url: '/atualizar-dados',
      method: 'POST',
      data: {
        descricao: descricao,
        modelo: modelo,
        eixo: eixo,
        mola_freio: mola_freio,
        tamanho: tamanho,
        rodado: rodado,
        pneu: pneu,
        descricao_generica: descricao_generica,
        filtro_nome:filtro_nome,
        // inclua outros dropdowns aqui
      },
      success: function(response) {
        // atualizar o DataFrame com os dados retornados
        var dadosAtualizados = response.dados;
        var descricaoAtualizada = response.descricao;
        var modeloAtualizado = response.modelo;
        var eixoAtualizado = response.eixo;
        var molaFreioAtualizado = response.mola_freio;
        var tamanhoAtualizado = response.tamanho;
        var rodadoAtualizado = response.rodado;
        var pneuAtualizado = response.pneu;
        var descricaoGenericaAtualizado = response.descricao_generica;
        var filtroNomeAtualizado = response.descricao_generica;

        // faça o processamento necessário para atualizar o DataFrame na página

        // atualizar a tabela com os dados retornados
        atualizarTabela(dadosAtualizados);
        atualizarDropdowns(descricaoAtualizada,modeloAtualizado,eixoAtualizado,molaFreioAtualizado,tamanhoAtualizado,rodadoAtualizado,pneuAtualizado,descricaoGenericaAtualizado);
        $("#loading-overlay").hide(); // Oculta o overlay após atualizar os dados

      },
      error: function(error) {
        console.log(error);
        $("#loading-overlay").hide(); // Oculta o overlay após atualizar os dados
      }
    });
  
  }

  
  function atualizarTabela(dados) {
    $("#loading-overlay").show();
    var tabela = $('#table1 tbody');
    tabela.empty(); // limpar a tabela antes de adicionar os novos dados

    dados.forEach(function(row) {

        var variavel1 = `${row[30]}`;

        var favoritoCheckbox = '';
          if (variavel1 === 'on') {
            favoritoCheckbox = `
              <input class=s"btn btn-secondary btn-sm favorito-btn" type="checkbox" name="favorito" id="favorito" data-row-id="${row[1]}" checked> 
              <span class="slider round"></span>
            `;
          } else {
            favoritoCheckbox = ` 
              <input class="btn btn-secondary btn-sm favorito-btn" type="checkbox" name="favorito" id="favorito" data-row-id="${row[1]}"> 
              <span class="slider round"></span>
            `;
          }
          
        console.log(variavel1);

        var html = `
          <tr>
            <td data-label="Modelo">${row[11]}</td>
            <td data-label="Código" id="codigo">${row[1]}</td>
            <td data-label="Descrição">${row[2]}</td>
            <td data-label="Cor">
              <select id="cor" class="cor-dropdown">
                <option value="Laranja" selected>Laranja</option>
                <option value="Verde">Verde</option>
                <option value="Vermelha">Vermelha</option>
                <option value="Azul">Azul</option>
                <option value="Amarela">Amarela</option>
              </select>
            </td>
            <td data-label="Preço" style="white-space: nowrap;">${row[23]}</td>
            <td data-label="Preço Final">
              <input class="row-data preco-input" name="preco" placeholder="Preço c/ desc." style="width: 115px;" oninput="formatPriceInput(event);">
            </td>
            <td data-label="Favorito">
              <div class="toggle" id="maquina-parada-toggle">
                <label class="switch2">
                  ${favoritoCheckbox}
                </label>
              </div>
            </td>
            <td data-label="Selecionar">
              <button class="btn btn-primary btn-sm" onclick="toggleRowColor(this); toggleCardItem(this);" id="botão_enviar_carrinho"><i class="fa-sharp fa-solid fa-paper-plane"></i>   Enviar</button>
            </td>
          </tr>`;

        tabela.append(html);
      
      });

      $("#loading-overlay").hide();
    }


  function atualizarDropdowns(descricao, modelo, eixo, mola_freio, tamanho, rodado, pneu, descricao_generica) {
    $("#loading-overlay").show();
    var descricaoDropdown = $('#filtro-descricao');
    var modeloDropdown = $('#filtro-modelo');
    var eixoDropdown = $('#filtro-eixo');
    var molaFreioDropdown = $('#filtro-molaFreio');
    var tamanhoDropdown = $('#filtro-tamanho');
    var rodadoDropdown = $('#filtro-rodado');
    var pneuDropdown = $('#filtro-pneu');
    var descricaoGenericaDropdown = $('#filtro-descricao-generica');
    var filtroSelect = $('#filtro-nome');

    // Armazenar os valores selecionados atualmente
    var descricaoSelecionada = descricaoDropdown.val();
    var modeloSelecionado = modeloDropdown.val();
    var eixoSelecionado = eixoDropdown.val();
    var molaFreioSelecionado = molaFreioDropdown.val();
    var tamanhoSelecionado = tamanhoDropdown.val();
    var rodadoSelecionado = rodadoDropdown.val();
    var pneuSelecionado = pneuDropdown.val();
    var descricaoGenericaSelecionado = descricaoGenericaDropdown.val();
    
    descricaoDropdown.empty();
    modeloDropdown.empty();
    eixoDropdown.empty();
    molaFreioDropdown.empty();
    tamanhoDropdown.empty();
    rodadoDropdown.empty();
    pneuDropdown.empty();
    descricaoGenericaDropdown.empty();

    // Adicionar a opção "Todos" em todos os dropdowns
    descricaoDropdown.append($('<option>').text('Selecionar').attr('value', ''));
    modeloDropdown.append($('<option>').text('Selecionar').attr('value', ''));
    eixoDropdown.append($('<option>').text('Selecionar').attr('value', ''));
    molaFreioDropdown.append($('<option>').text('Selecionar').attr('value',''));
    tamanhoDropdown.append($('<option>').text('Selecionar').attr('value',''));
    rodadoDropdown.append($('<option>').text('Selecionar').attr('value',''));
    pneuDropdown.append($('<option>').text('Selecionar').attr('value',''));
    descricaoGenericaDropdown.append($('<option>').text('Selecionar').attr('value',''));

    // Preencher os valores dos dropdowns e selecionar o valor atual, se existir
    $.each(descricao, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === descricaoSelecionada) {
        option.attr('selected', 'selected');
      }
      descricaoDropdown.append(option);
    });

    $.each(modelo, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === modeloSelecionado) {
        option.attr('selected', 'selected');
      }
      modeloDropdown.append(option);
    });

    $.each(eixo, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === eixoSelecionado) {
        option.attr('selected', 'selected');
      }
      eixoDropdown.append(option);
    });

    $.each(mola_freio, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === molaFreioSelecionado) {
        option.attr('selected', 'selected');
      }
      molaFreioDropdown.append(option);
    });

    $.each(tamanho, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === tamanhoSelecionado) {
        option.attr('selected', 'selected');
      }
      tamanhoDropdown.append(option);
    });

    $.each(rodado, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === rodadoSelecionado) {
        option.attr('selected', 'selected');
      }
      rodadoDropdown.append(option);
    });

    $.each(pneu, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === pneuSelecionado) {
        option.attr('selected', 'selected');
      }
      pneuDropdown.append(option);
    });

    $.each(descricao_generica, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === descricaoGenericaSelecionado) {
        option.attr('selected', 'selected');
      }
      descricaoGenericaDropdown.append(option);
    });

    $("#loading-overlay").hide();
    // Atualize os outros dropdowns conforme necessário
  }

</script>

<script>// Botão para limpar os filtros
  
  function limparFiltros() {
    var descricaoGenericaSelect = $('#filtro-descricao');
    var modeloSelect = $('#filtro-modelo');
    var eixoSelect = $('#filtro-eixo');
    var molaFreioSelect = $('#filtro-molaFreio');
    var tamanhoSelect = $('#filtro-tamanho');
    var rodadoSelect = $('#filtro-rodado');
    var pneuSelect = $('#filtro-pneu');
    var adicionaisSelect = $('#filtro-descricao-generica');

    // Defina o valor "Todos" para cada dropdown
    descricaoGenericaSelect.val('');
    modeloSelect.val('');
    eixoSelect.val('');
    molaFreioSelect.val('');
    tamanhoSelect.val('');
    rodadoSelect.val('');
    pneuSelect.val('');
    adicionaisSelect.val('');

    // Dispare o evento "change" para acionar a ação desejada
    descricaoGenericaSelect.trigger('change');
    modeloSelect.trigger('change');
    eixoSelect.trigger('change');
    molaFreioSelect.trigger('change');
    tamanhoSelect.trigger('change');
    rodadoSelect.trigger('change');
    pneuSelect.trigger('change');
    adicionaisSelect.trigger('change');

    // Enviar a solicitação AJAX para atualizar os dados
    $.ajax({
      url: '/atualizar-dados',
      method: 'POST',
      data: {
        descricao: descricaoGenericaSelect.val(),
        modelo: modeloSelect.val(),
        eixo: eixoSelect.val(),
        mola_freios: molaFreioSelect.val(),
        tamanho: tamanhoSelect.val(),
        rodado: rodadoSelect.val(),
        pneu: pneuSelect.val(),
        adicionais: adicionaisSelect.val()
        // inclua outros dropdowns aqui
      },
      success: function(response) {
        // atualizar o DataFrame com os dados retornados
        var dadosAtualizados = response.dados;
        var descricaoAtualizada = response.descricao;
        var modeloAtualizado = response.modelo;
        var eixoAtualizado = response.eixo;
        var molaFreioAtualizado = response.mola_freio;
        var tamanhoAtualizado = response.tamanho;
        var rodadoAtualizado = response.rodado;
        var pneuAtualizado = response.pneu;
        var descricaoGenericaAtualizado = response.adicionais;

        // faça o processamento necessário para atualizar o DataFrame na página

        // atualizar a tabela com os dados retornados
        atualizarTabela(dadosAtualizados);
        atualizarDropdowns(descricaoAtualizada,modeloAtualizado,eixoAtualizado,molaFreioAtualizado,tamanhoAtualizado,rodadoAtualizado,pneuAtualizado,descricaoGenericaAtualizado);
      },
    });
  }
</script>

<script>// Atualizar dados de dropdow de clientes
  function atualizarCliente() {
    $("#loading-overlay").show();
  
    var nome_cliente = $('#filtro-nome').val();
    var contato_cliente = $('#filtro-contato').val();
    var condicoes = $('#forma-pagamento').val();

    // obter os valores selecionados em cada dropdown

    // enviar a solicitação AJAX para o servidor
    $.ajax({
      url: '/atualizar-cliente',
      method: 'POST',
      data: {
        nome_cliente: nome_cliente,
        contato_cliente: contato_cliente,
        condicoes: condicoes
        // inclua outros dropdowns aqui
      },
      success: function(response) {
        // atualizar o DataFrame com os dados retornados
        var nomeClienteAtualizado = response.nome_cliente;
        var contatoClienteAtualizado = response.contato_cliente;
        var formaPagamentoAtualizado = response.condicoes;

        // faça o processamento necessário para atualizar o DataFrame na página

        // atualizar a tabela com os dados retornados
        atualizarDropdownsCliente(contatoClienteAtualizado,formaPagamentoAtualizado)
        $("#loading-overlay").hide(); // Oculta o overlay após atualizar os dados

      },
      error: function(error) {
        console.log(error);
        $("#loading-overlay").hide(); // Oculta o overlay após atualizar os dados
      }
    });
  }

  function atualizarDropdownsCliente(contato_cliente,formaPagamento) {

    $("#loading-overlay").show();
    var contatoClienteDropdown = $('#filtro-contato');
    var formaPagamentoDropdown = $('#forma-pagamento');

    var contatoClienteSelecionado = contatoClienteDropdown.val();
    var formaPagamentoSelecionado = formaPagamentoDropdown.val();

    contatoClienteDropdown.empty();
    formaPagamentoDropdown.empty();

    contatoClienteDropdown.append($('<option>').text('Selecionar').attr('value', ''));
    formaPagamentoDropdown.append($('<option>').text('Selecionar').attr('value', ''));

    $.each(contato_cliente, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === contatoClienteSelecionado) {
        option.attr('selected', 'selected');
      }
      contatoClienteDropdown.append(option);
    });

    $.each(formaPagamento, function(index, value) {
      var option = $('<option>').text(value).attr('value', value);
      if (value === formaPagamentoSelecionado) {
        option.attr('selected', 'selected');
      }
      formaPagamentoDropdown.append(option);
    });


    $("#loading-overlay").hide();

  }
</script>

<script>// Function to format the price input

  function formatPriceInput(event) {
    const input = event.target;
    const rawValue = input.value;

    // Remove any non-digit characters from the input value
    const cleanedValue = rawValue.replace(/[^0-9]/g, '');

    // Format the cleaned value as Brazilian Real
    const formattedValue = formatAsReal(cleanedValue);

    // Set the formatted value back to the input
    input.value = formattedValue;

    // Clear the input if the formatted value is "0.00"
    if (formattedValue === "R$ 0,00") {
      input.value = '';
    }
  }

    // Function to format a number as Brazilian Real
    function formatAsReal(value) {
      // Convert the value to a number
      const number = Number(value);
    
      // Check if the number is valid
      if (isNaN(number)) {
        return '';
      }
    
      // Split the number into integer and decimal parts
      const integerPart = Math.floor(number / 100);
      const decimalPart = number % 100;
    
      // Format the integer part with thousands separator
      const formattedIntegerPart = integerPart.toLocaleString('pt-BR');
    
      // Format the decimal part with two decimal places
      const formattedDecimalPart = decimalPart.toString().padStart(2, '0');
    
      // Construct the formatted value as Brazilian Real
      const formattedValue = `R$ ${formattedIntegerPart},${formattedDecimalPart}`;
    
      return formattedValue;
    }
    
</script>

<script>
  // Função para enviar os dados para o backend usando fetch
  function sendData(items, nome, contato, formaPagamento, observacoes) {
    // Crie um objeto com os dados do formulário
    var formData = {
      items: items,
      nome: nome,
      contato: contato,
      formaPagamento: formaPagamento,
      observacoes: observacoes
    };

    // Faça uma requisição POST para o backend usando fetch
    fetch('/receber-dados', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    })
      .then(response => {
        if (response.ok) {
          // Recarrega a página após um breve intervalo de tempo
          location.reload();
        } else {
          console.error('Ocorreu um erro ao enviar os itens.');
        }
      })
      .catch(error => {
        console.error('Ocorreu um erro ao enviar os itens:', error);
      });
  }

  // Função para lidar com o clique no botão "Enviar"
  function handleEnviarButtonClick() {
    // Exibe o carregamento
    $("#loading-overlay").show();

    const items = [];

    // Obtenha todos os itens da lista
    const listItems = document.querySelectorAll('.listCard li');

    // Percorra os itens e obtenha os dados
    listItems.forEach(listItem => {
      const description = listItem.getAttribute('data-description');
      const corElement = listItem.querySelector('.cor');
      const cor = corElement.textContent;
      const quantiElement = listItem.querySelector('.quanti');
      const quanti = quantiElement.textContent;
      const numerosElement = listItem.querySelector('.numeros');
      const numeros = numerosElement.textContent;

      // Crie um objeto com os dados do item
      const item = {
        description: description,
        cor: cor,
        quanti: quanti,
        numeros: numeros
      };

      // Adicione o item à lista de itens
      items.push(item);
    });

    // Obtenha os valores dos campos adicionais do formulário
    var nome = document.getElementById('filtro-nome').value;
    var contato = document.getElementById('filtro-contato').value;
    var formaPagamento = document.getElementById('forma-pagamento').value;
    var observacoes = document.getElementById('observacao').value;

    // Chame a função para enviar os dados para o backend usando fetch
    sendData(items, nome, contato, formaPagamento, observacoes);
  }

  // Obtenha o botão "Enviar"
  const enviarButton = document.getElementById('enviar-button');

  // Adicione um evento de clique ao botão "Enviar"
  enviarButton.addEventListener('click', handleEnviarButtonClick);
</script>

<script>// Atualizar dados de dropdow de clientes
  function atualizar_regiao() {
    $("#loading-overlay").show();
  
    var nome_cliente = $('#filtro-nome').val();
    var contato_cliente = $('#filtro-contato').val();
    var condicoes = $('#forma-pagamento').val();

    // obter os valores selecionados em cada dropdown

    // enviar a solicitação AJAX para o servidor
    $.ajax({
      url: '/filtrar_regiao',
      method: 'POST',
      data: {
        nome_cliente: nome_cliente
        // inclua outros dropdowns aqui
      },
      success: function(response) {
        // atualizar o DataFrame com os dados retornados
        var nomeClienteAtualizado = response.nome_cliente;

        const filtroNome = document.getElementById('filtro-nome').value;
        const filtroContato = document.getElementById('filtro-contato').value;
        const formaPagamento = document.getElementById('forma-pagamento').value;

        // Verifica se algum dos campos está vazio
        if (filtroNome === '' || filtroContato === '' || formaPagamento === '') {
          $("#loading-overlay").hide();
          return;
        }

        // Se todos os campos estiverem preenchidos, mostra os filtros e o botão de limpar
        const filtros = document.querySelectorAll('.hidden');
        const botaoFiltrar = document.getElementById('filtrar');

        if (filtros.length > 0) {
          filtros.forEach((filtro) => {
            filtro.classList.remove('hidden');
          });
        }

        $("#loading-overlay").hide();
      },
      error: function(error) {
        console.log(error);
        $("#loading-overlay").hide(); // Oculta o overlay após atualizar os dados
      }
    });
    
  }
</script>

{% endblock %}