{% extends "layout.html" %}
{% block body %}

<div class="container filter-wrapper">
  <div>
    <label for="filtro-descricao">Descrição:</label>
    <select id="filtro-descricao" onchange="atualizarDados()">
        <option value="">Todos</option>
        {% for descricao in descricao_unique %}
        <option>{{descricao[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div>
    <label for="filtro-modelo">Modelo:</label>
    <select id="filtro-modelo" onchange="atualizarDados()">
      <option value="">Todos</option>
      {% for modelo in modelo_unique %}
      <option>{{modelo[0]}}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="filtro-eixo">Eixo:</label>
    <select id="filtro-eixo" onchange="atualizarDados()">
      <option value="">Todos</option>
      {% for eixo in eixo_unique %}  
      <option>{{eixo[0]}}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="filtro-molaFreio">Mola/Freio:</label>
    <select id="filtro-molaFreio">
        <option value="">Todos</option>
        {% for mola in mola_freio_unique %}
        <option>{{mola[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div>
    <label for="filtro-tamanho">Tamanho:</label>
    <select id="filtro-tamanho">
        <option value="">Todos</option>
        {% for tamanho in tamanho_unique %}
        <option>{{tamanho[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div>
    <label for="filtro-rodado">Rodado:</label>
    <select id="filtro-rodado">
        <option value="">Todos</option>
        {% for rodado in rodado_unique %}
        <option>{{rodado[0]}}</option>
        {% endfor %}
    </select>
  </div>
  <div>
    <label for="filtro-pneu">Pneu:</label>
    <select id="filtro-pneu">
        <option value="">Todas</option>
        {% for pneu in pneu_unique %}
        <option>{{pneu[0]}}</option>
        {% endfor %}
    </select>
  </div>

    <button onclick="enviarDados()">Enviar Dados Selecionados</button>
    <button id="limpar-filtros-btn" class="btn btn-secondary">Limpar Filtros</button>

</div>
    <!-- {% for row in data %}
      <div class="familia">{{row.familia}}</div>
      <div class="codigo">{{row.codigo}}</div>
      <div class="descricao">{{row.descricao}}</div>
      <input class="row-data cor-input" name="cor" style="width: 60px;">
      <div class="preco">{{row.preco}}</div>
      <button onclick=addToCard(1)>Add</button>
    {% endfor %} -->
<div class="container pt-4" style="transition: 0.5s;">
    <h2>Lista de preços</h2>
    <div class="row">
        <div style="position: relative;">
            <a href="/export/pdf-all">
                <i class="fas fa-file-pdf" style="font-size:20px;color:red"></i>
            </a>
            <table id="table1" class="table table-striped responsive-table">
              <thead>
                  <tr>
                      <th>Família</th>
                      <th>Código</th>
                      <th>Descrição</th>
                      <th>Cor</th>
                      <th>Preço</th>
                      <th>Preço Final</th>
                      <th>Total</th>
                  </tr>
              </thead>
              <tbody>
                  {% for row in data %}
                  <tr>
                    <td>{{row[11]}}</td>
                    <td>{{row[1]}}</td>
                    <td>{{row[2]}}</td>
                    <td>
                      <select id="cor" class="cor-dropdown">
                        <option value="" selected disabled hidden></option>
                        <option value="Laranja">Laranja</option>
                        <option value="Verde">Verde</option>
                        <option value="Vermelho">Vermelho</option>
                        <option value="Azul">Azul</option>
                        <option value="Amarelo">Amarelo</option>
                      </select>
                    </td>
                    <td style="white-space: nowrap;">{{row[23]}}</td>
                    <td>
                      <input class="row-data preco-input" name="preco" style="width: 100px;" oninput="formatPriceInput(event);">
                    </td>
                    <td class="row-total"></td>
                    <td>
                      <a id= 'favorito' href="" class="btn btn-secondary btn-sm">
                        <i class="fas fa-star"></i>
                      </a>
                    </td>
                    <td>
                      <input type="checkbox" name="item[]" value="{{row.id}}" onchange="toggleRowColor(this); toggleCardItem(this);">
                    </td>                    
                  </tr>
                  {% endfor %}
                </tbody>
            </table>  
        </div>
    </div>
</div>

<script>
  function atualizarDados() {
    var descricao = $('#filtro-descricao').val();
    var modelo = $('#filtro-modelo').val();
    var eixo = $('#filtro-eixo').val();
    // obter os valores selecionados em cada dropdown

    // enviar a solicitação AJAX para o servidor
    $.ajax({
      url: '/atualizar-dados',
      method: 'POST',
      data: {
        descricao: descricao,
        modelo: modelo,
        eixo: eixo
        // inclua outros dropdowns aqui
      },
      success: function(response) {
        // atualizar o DataFrame com os dados retornados
        var dadosAtualizados = response.dados;
        var descricaoAtualizada = response.descricao;
        var modeloAtualizado = response.modelo;
        var eixoAtualizado = response.eixo;
        // faça o processamento necessário para atualizar o DataFrame na página

        // atualizar a tabela com os dados retornados
        atualizarTabela(dadosAtualizados);
        atualizarDropdowns(descricaoAtualizada, modeloAtualizado, eixoAtualizado);

      },
      error: function(error) {
        console.log(error);
      }
    });
  }

  function atualizarTabela(dados) {
    var tabela = $('#table1 tbody');
    tabela.empty(); // limpar a tabela antes de adicionar os novos dados

    dados.forEach(function(row) {
      var html = `
        <tr>
          <td>${row[11]}</td>
          <td>${row[1]}</td>
          <td>${row[2]}</td>
          <td>
            <select id="cor" class="cor-dropdown">
              <option value="" selected disabled hidden></option>
              <option value="Laranja">Laranja</option>
              <option value="Verde">Verde</option>
              <option value="Vermelho">Vermelho</option>
              <option value="Azul">Azul</option>
              <option value="Amarelo">Amarelo</option>
            </select>
          </td>
          <td style="white-space: nowrap;">${row[23]}</td>
          <td>
            <input class="row-data preco-input" name="preco" style="width: 100px;" oninput="formatPriceInput(event);">
          </td>
          <td class="row-total"></td>
          <td>
            <a id= 'favorito' href="" class="btn btn-secondary btn-sm">
              <i class="fas fa-star"></i>
            </a>
          </td>
          <td>
            <input type="checkbox" name="item[]" value="${row.id}" onchange="toggleRowColor(this); toggleCardItem(this);">
          </td>                    
        </tr>
      `;
      tabela.append(html);
    });
  }

  function atualizarDropdowns(descricao, modelo, eixo) {
    var descricaoDropdown = $('#filtro-descricao');
    var modeloDropdown = $('#filtro-modelo');
    var eixoDropdown = $('#filtro-eixo');

    // Armazenar os valores selecionados atualmente
    var descricaoSelecionada = descricaoDropdown.val();
    var modeloSelecionado = modeloDropdown.val();
    var eixoSelecionado = eixoDropdown.val();

    descricaoDropdown.empty();
    modeloDropdown.empty();
    eixoDropdown.empty();

    // Adicionar a opção "Todos" em todos os dropdowns
    descricaoDropdown.append($('<option>').text('Todos').attr('value', ''));
    modeloDropdown.append($('<option>').text('Todos').attr('value', ''));
    eixoDropdown.append($('<option>').text('Todos').attr('value', ''));

    // Preencher os valores dos dropdowns e selecionar o valor atual, se existir
    $.each(descricao, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === descricaoSelecionada) {
        option.attr('selected', 'selected');
      }
      descricaoDropdown.append(option);
    });

    $.each(modelo, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === modeloSelecionado) {
        option.attr('selected', 'selected');
      }
      modeloDropdown.append(option);
    });

    $.each(eixo, function(index, value) {
      var option = $('<option>').text(value[0]).attr('value', value[0]);
      if (value[0] === eixoSelecionado) {
        option.attr('selected', 'selected');
      }
      eixoDropdown.append(option);
    });

    // Atualize os outros dropdowns conforme necessário
  }
</script>

<script>
  $(document).ready(function() {
    // ...

    // Manipulador de eventos para o clique no botão de limpar filtros
    $('#limpar-filtros-btn').click(function() {
      // Limpar os valores dos dropdowns e selecionar a opção "Todos"
      $('#filtro-descricao').val('');
      $('#filtro-modelo').val('');
      $('#filtro-eixo').val('');
      // Limpar a tabela e atualizar com os dados originais
      atualizarTabela(data); // Utilize a variável 'data' que contém os dados originais da tabela
      // Atualizar os dropdowns com a opção "Todos"
      atualizarDropdowns(descricao_unique, modelo_unique, eixo_unique);
    });

    // ...
  });
</script>

<script>

    function enviarDados() {
        var checkboxes = document.querySelectorAll('input[name="item[]"]:checked');
        var dadosSelecionados = [];
    
        for (var i = 0; i < checkboxes.length; i++) {
        dadosSelecionados.push(checkboxes[i].value);
        }
    
        // Enviar os dados selecionados para o backend via AJAX
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/checkbox', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            console.log('Dados enviados com sucesso!');
        }
        };
        xhr.send(JSON.stringify(dadosSelecionados));
    }

</script>

<script>// Function to format the price input

function formatPriceInput(event) {
  const input = event.target;
  const rawValue = input.value;

  // Remove any non-digit characters from the input value
  const cleanedValue = rawValue.replace(/[^0-9]/g, '');

  // Format the cleaned value as Brazilian Real
  const formattedValue = formatAsReal(cleanedValue);

  // Set the formatted value back to the input
  input.value = formattedValue;

  // Clear the input if the formatted value is "0.00"
  if (formattedValue === "R$ 0,00") {
    input.value = '';
  }
}

  // Function to format a number as Brazilian Real
  function formatAsReal(value) {
    // Convert the value to a number
    const number = Number(value);
  
    // Check if the number is valid
    if (isNaN(number)) {
      return '';
    }
  
    // Split the number into integer and decimal parts
    const integerPart = Math.floor(number / 100);
    const decimalPart = number % 100;
  
    // Format the integer part with thousands separator
    const formattedIntegerPart = integerPart.toLocaleString('pt-BR');
  
    // Format the decimal part with two decimal places
    const formattedDecimalPart = decimalPart.toString().padStart(2, '0');
  
    // Construct the formatted value as Brazilian Real
    const formattedValue = `R$ ${formattedIntegerPart},${formattedDecimalPart}`;
  
    return formattedValue;
  }
  
</script>

{% endblock %}